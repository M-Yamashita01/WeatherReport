version: 2
jobs:
  build:
    docker:
      - image: circleci/ruby:2.6.5
    working_directory: ~/WeatherReport
    steps:
      - checkout
      - setup_remote_docker
      - restore_cache:
          keys:
            - v1-{{ checksum "Gemfile.lock" }}
          path:
            - ~/caches/images.tar

      - run:
          command: |
            if [[ -e ~/caches/images.tar ]]; then
              docker load -i ~/caches/images.tar
            fi
          name: docker load

      - run:
          name: docker-compose up
          command: |
            set -x
            sudo docker-compose -f docker-compose.test.yml up --force-recreate --build -d
      
      - run:
          name: run tests
          command: |
            mkdir -p /tmp/test-results
            TEST_FILES="$(circleci tests glob 'spec/**/*_spec.rb' | circleci tests split --split-by=timings)"
            sudo docker-compose -f docker-compose.test.yml exec web bundle exec rspec --format progress \
                                                                  --format RspecJunitFormatter \
                                                                  --out /tmp/test-results/rspec.xml \
                                                                  $TEST_FILES            
            
      # Save test results for timing analysis
      - store_test_results:
          path: /tmp/test-results

      - run:
          name: docker-compose down
          command: |
            set -x
            sudo docker-compose down

      - save_cache:
          key: v1-{{ checksum "Gemfile.lock" }}
          paths:
            - ~/caches/images.tar
